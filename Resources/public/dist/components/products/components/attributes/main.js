define(["config","text!suluproduct/components/products/components/attributes/overlay-content.html"],function(a,b){"use strict";var c="#product-attributes-form",d="product-attribute-list-toolbar",e="product-attribute-datagrid",f="product-attribute-overlay",g="product-attribute-select",h="product.attribute.type.text",i=null,j=60,k={ADD:1,DELETE:2,UPDATE:3},l=function(){this.sandbox.on("sulu.header.toolbar.delete",function(){this.sandbox.emit("sulu.product.delete",this.options.data.id)}.bind(this)),this.sandbox.on("product.state.change",function(a){this.options.data.status&&this.options.data.status.id===a||(this.status={id:a},this.options.data.status=this.status,m.call(this,!1))},this),this.sandbox.on("sulu.header.back",function(){this.sandbox.emit("sulu.products.list")},this),this.sandbox.on("sulu.header.toolbar.save",function(){this.sendData={},this.sendData.status=this.status,q.call(this)},this),this.sandbox.on("sulu.products.saved",function(a){var b=a.attributes;if(a.action===k.ADD){var c=_.findWhere(b,{attributeId:a.attributeId});this.sandbox.emit("husky.datagrid."+e+".record.add",{id:c.id,attributeId:c.attributeId,value:c.value,attributeName:c.attributeName})}else a.action===k.DELETE?$.each(a.deleteIds,function(a,b){this.sandbox.emit("husky.datagrid."+e+".record.remove",b)}.bind(this)):a.action===k.UPDATE&&this.sandbox.emit("husky.datagrid."+e+".records.change",b);m.call(this,!0),this.options.data.attributes.status=this.status},this)},m=function(a){var b=this.options.data&&this.options.data.id?"edit":"add";this.sandbox.emit("sulu.header.toolbar.state.change",b,a,!0)},n=function(){i=null;var a=this.sandbox.dom.createElement(this.sandbox.util.template(b,{translate:this.sandbox.translate}));return this.sandbox.dom.append(this.$el,a),a},o=function(){var a="pim.product.title",b=[{title:"navigation.pim"},{title:"pim.products.title"}];this.options.data&&this.options.data.attributes.name&&(a=this.options.data.attributes.name),a=this.sandbox.util.cropTail(a,j),this.sandbox.emit("sulu.header.set-title",a),this.options.data&&this.options.data.attributes.number?b.push({title:"#"+this.options.data.attributes.number}):b.push({title:"pim.product.title"}),this.sandbox.emit("sulu.header.set-breadcrumb",b)},p=function(){var a=$.getJSON("api/attributes",function(a){this.attributeTypes=new Array,$.each(a._embedded.attributes,function(a,b){var c={id:b.id,name:b.name};b.type.name===h&&this.attributeTypes.push(c)}.bind(this))}.bind(this));a.done(function(){var a=this.sandbox.dom.createElement("<div>");this.sandbox.dom.append(this.$el,a),this.sandbox.start([{name:"overlay@husky",options:{el:a,supportKeyInput:!1,title:this.sandbox.translate("product.attribute.overlay.title"),skin:"normal",openOnStart:!0,removeOnClose:!0,instanceName:f,data:n.call(this),okCallback:r.bind(this)}}])}.bind(this)),a.fail(function(){console.log("Error retrieving attributes from server")}.bind(this)),a.complete(function(){var a=[];this.attributeTypes.length>0&&"object"==typeof this.attributeTypes[0]&&"string"==typeof this.attributeTypes[0].name&&(i=this.attributeTypes[0].id,a.push(this.attributeTypes[0].name));var b={el:"#selectBox",instanceName:g,multipleSelect:!1,defaultLabel:this.sandbox.translate("product.attribute.overlay.defaultlabel"),preSelectedElements:a,valueName:"name",isNative:!0,data:this.attributeTypes};this.sandbox.start([{name:"select@husky",options:b}]),this.sandbox.on("husky.select."+g+".selected.item",function(a){i=parseInt(a)})}.bind(this))},q=function(){this.sandbox.emit("sulu.products.save",this.sendData)},r=function(){if(i){this.sendData=new Object;var a=this.sandbox.dom.val("#attribute-name"),b=this.options.data.attributes.attributes,c=_.findWhere(b,{attributeId:i});if(c)c.value=a,this.sendData.action=k.UPDATE;else{var d={attributeId:i,value:a};b.push(d),this.sendData.action=k.ADD}this.sendData.attributeId=i,this.sendData.attributes=b,this.sendData.status=this.status,this.sendData.id=this.options.data.attributes.id,q.call(this)}},s=function(){this.sandbox.emit("husky.datagrid."+e+".items.get-selected",function(a){var b=this.options.data.attributes.attributes;this.sendData=new Object;var c=new Array;_.each(a,function(a,d,e){var f=_.findWhere(b,{id:a});b=_.without(b,f),c.push(a)}),this.sendData.deleteIds=c,this.sendData.attributes=b,this.sendData.status=this.status,this.sendData.id=this.options.data.id,this.sendData.action=k.DELETE,q.call(this)}.bind(this))},t=function(){var a={el:"#product-attribute-list",instanceName:e,resultKey:"attributes",matchings:[{name:"value",content:this.sandbox.translate("product.attribute.value")},{name:"attributeName",content:this.sandbox.translate("product.attribute.name")}],viewOptions:{table:{type:"checkbox"}},data:this.options.data.attributes};this.sandbox.start([{name:"datagrid@husky",options:a}]),this.sandbox.start([{name:"toolbar@husky",options:{el:"#product-attribute-selection-toolbar",instanceName:d,small:!1,data:[{id:"add",icon:"plus-circle",callback:p.bind(this)},{icon:"trash-o",disabled:!1,callback:s.bind(this)}]}}])},u=function(){this.sandbox.start(c),t.call(this)};return{name:"Sulu Product Attributes View",templates:["/admin/product/template/product/attributes"],render:function(){this.sandbox.dom.html(this.$el,this.renderTemplate("/admin/product/template/product/attributes")),u.call(this),o.call(this)},initialize:function(){l.call(this),this.status=this.options.data?this.options.data.attributes.status:a.get("product.status.active"),this.render()}}});